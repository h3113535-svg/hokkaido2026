<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ£®æ—åŒ—æµ·é“ 2026 (é›²ç«¯åˆ†å±¤ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F0F9FF; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .header-curve { border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-600">

    <div id="app" class="max-w-md mx-auto bg-slate-50 min-h-screen shadow-2xl relative pb-20 overflow-hidden">
        
        <transition name="fade">
            <div v-if="isLocked" class="absolute inset-0 z-[100] bg-blue-600 flex flex-col items-center justify-center text-white p-10">
                <i class="fa-solid fa-users text-6xl mb-4 opacity-80 animate-bounce"></i>
                <h2 class="text-2xl font-bold mb-2">Hokkaido 2026</h2>
                <p class="text-sm opacity-80 mb-8">Family Trip ãƒ» è«‹è¼¸å…¥å¯†ç¢¼</p>
                <div class="flex space-x-4 mb-8">
                    <div v-for="(digit, idx) in inputPassword" :key="idx" class="w-4 h-4 rounded-full" :class="digit ? 'bg-white' : 'bg-blue-400'"></div>
                </div>
                <div class="grid grid-cols-3 gap-6 w-64">
                    <button v-for="n in 9" :key="n" @click="enterDigit(n)" class="w-16 h-16 rounded-full border-2 border-blue-400 flex items-center justify-center text-xl font-bold active:bg-blue-500 transition">{{ n }}</button>
                    <div class="col-start-2">
                        <button @click="enterDigit(0)" class="w-16 h-16 rounded-full border-2 border-blue-400 flex items-center justify-center text-xl font-bold active:bg-blue-500 transition">0</button>
                    </div>
                    <div class="col-start-3 flex items-center justify-center">
                        <button @click="backspace()" class="w-16 h-16 flex items-center justify-center text-xl active:opacity-50"><i class="fa-solid fa-delete-left"></i></button>
                    </div>
                </div>
            </div>
        </transition>

        <header class="relative z-10">
            <div class="h-[250px] w-full bg-blue-200 header-curve overflow-hidden relative shadow-lg">
                <img :src="headerImage" class="w-full h-full object-cover object-center opacity-90">
                <div class="absolute bottom-12 left-6 text-white text-shadow">
                    <h1 class="text-2xl font-bold tracking-widest drop-shadow-md">HOKKAIDO</h1>
                    <p class="text-sm font-light tracking-wider drop-shadow-md">Family Trip 2026</p>
                </div>
                <div class="absolute top-4 right-4 bg-black/30 backdrop-blur-md text-white text-[10px] px-3 py-1 rounded-full flex items-center">
                    <div class="w-2 h-2 rounded-full mr-2" :class="dbConnected ? 'bg-green-400' : 'bg-red-400 animate-pulse'"></div>
                    {{ dbConnected ? 'å·²é€£ç·š' : 'é€£ç·šä¸­' }}
                </div>
            </div>
            
            <div class="absolute -bottom-6 right-4 flex space-x-3 z-20">
                <button v-for="tab in ['schedule', 'info', 'shopping', 'expense']" @click="switchTab(tab)" :class="tabClass(tab)" class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all transform hover:-translate-y-1">
                    <i :class="getTabIcon(tab)" class="text-lg"></i>
                </button>
            </div>
        </header>

        <main class="relative z-0 -mt-4 pt-10 px-4 min-h-[500px]">

            <div v-if="currentTab === 'schedule'">
                 <div class="flex overflow-x-auto space-x-3 pb-4 hide-scrollbar mb-2">
                    <div v-for="(day, index) in scheduleData" :key="index" @click="selectedDayIndex = index"
                         :class="selectedDayIndex === index ? 'bg-blue-500 text-white ring-4 ring-blue-100' : 'bg-white text-slate-400'"
                         class="flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer shadow-sm border border-slate-100 transition-all">
                        <span class="text-xs font-medium">{{ day.weekday }}</span>
                        <span class="text-2xl font-bold font-mono">{{ day.date }}</span>
                        <span class="text-[10px] opacity-80">D{{ index + 1 }}</span>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-blue-400 to-cyan-300 text-white rounded-2xl p-4 mb-6 shadow-md flex justify-between items-center relative overflow-hidden min-h-[100px]">
                    <div class="relative z-10">
                        <div class="text-xs opacity-90"><i class="fa-solid fa-location-dot mr-1"></i>{{ currentSchedule.location }}</div>
                        <div v-if="weatherLoading" class="mt-2 text-sm opacity-80">å¤©æ°£è¼‰å…¥ä¸­...</div>
                        <div v-else><div class="text-3xl font-bold mt-1">{{ currentWeather.temp }}Â°C <span class="text-sm font-normal">{{ currentWeather.desc }}</span></div></div>
                    </div>
                    <i :class="currentWeather.icon" class="text-5xl opacity-80 relative z-10"></i>
                </div>

                <div class="space-y-0">
                    <div v-for="(item, idx) in currentSchedule.events" :key="idx" class="relative pl-6 pb-8 border-l-2 border-dashed border-blue-200 last:border-0">
                        <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-blue-500 ring-4 ring-blue-100"></div>
                        <div v-if="idx > 0" class="flex items-center text-xs text-slate-400 mb-2 ml-1"><i :class="getTransportIcon(item.transportType)" class="mr-2"></i><span>{{ item.travelTime }}</span></div>
                        <div v-else-if="idx === 0" class="flex items-center text-xs text-slate-400 mb-2 ml-1"><i class="fa-solid fa-bed mr-2"></i><span>å¾ä½å®¿å‡ºç™¼</span></div>
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group hover:shadow-md transition">
                            <span :class="getCategoryColor(item.category)" class="absolute top-0 right-0 px-3 py-1 text-[10px] rounded-bl-xl font-bold text-white">{{ item.category }}</span>
                            <div class="flex items-start">
                                <div class="mr-3 mt-1 text-blue-500 text-xl"><i :class="getCategoryIcon(item.category)"></i></div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-slate-700 text-lg leading-tight mb-1">{{ item.title }}</h3>
                                    <p class="text-xs text-slate-500 font-mono mb-2"><i class="fa-regular fa-clock mr-1"></i>{{ item.time }}</p>
                                    <div v-if="item.image" class="mb-3 mt-2 rounded-lg overflow-hidden h-32 w-full relative"><img :src="item.image" class="w-full h-full object-cover"></div>
                                    <p v-if="item.note" class="text-sm text-slate-600 bg-slate-50 p-2 rounded-lg mb-2">{{ item.note }}</p>
                                    <a :href="'https://www.google.com/maps/search/?api=1&query=' + item.title" target="_blank" class="inline-flex items-center text-xs font-bold text-blue-500 mt-1 hover:text-blue-700"><i class="fa-solid fa-location-arrow mr-1"></i> å°èˆª</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'info'" class="space-y-4">
                <h2 class="text-xl font-bold text-slate-800">æ—…è¡Œè³‡è¨Š</h2>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-blue-600 mb-4 flex justify-between"><span><i class="fa-solid fa-coins mr-2"></i>åŒ¯ç‡è¨ˆç®—æ©Ÿ</span></h3>
                    <div class="bg-blue-50 p-3 rounded-lg mb-4 flex items-center justify-between">
                        <span class="text-xs text-blue-500 font-bold">åŒ¯ç‡è¨­å®š</span>
                        <div class="flex items-center bg-white rounded px-2 py-1"><span class="text-xs text-slate-400 mr-2">1 JPY =</span><input v-model="exchangeRate" type="number" step="0.001" class="w-16 text-right font-bold text-blue-600 outline-none text-sm"><span class="text-xs text-slate-400 ml-1">TWD</span></div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="flex-1"><label class="text-[10px] text-slate-400 block mb-1">æ—¥å¹£</label><input v-model="yenAmount" type="number" class="w-full bg-slate-100 rounded-lg p-2 outline-none font-mono"></div>
                        <i class="fa-solid fa-arrow-right text-slate-300 mt-4"></i>
                        <div class="flex-1"><label class="text-[10px] text-slate-400 block mb-1">å°å¹£</label><div class="w-full bg-slate-200 rounded-lg p-2 font-mono font-bold text-slate-700">{{ calculatedTwd }}</div></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="info in infoCards" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center h-32 hover:border-blue-300 transition cursor-pointer">
                        <div :class="info.bgClass" class="w-10 h-10 rounded-full flex items-center justify-center mb-2"><i :class="info.icon" class="text-xl"></i></div>
                        <span class="font-bold text-sm">{{ info.title }}</span>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'shopping'">
                <div v-if="!activeMember">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">å…¨å®¶è³¼ç‰©è»Š <span class="text-xs font-normal text-slate-400 ml-2">(é»æ“Šé ­åƒé€²å…¥)</span></h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div v-for="member in familyMembers" :key="member.name" @click="activeMember = member.name" 
                             class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center cursor-pointer hover:shadow-md hover:border-blue-300 transition relative overflow-hidden">
                            <div class="w-16 h-16 rounded-full mb-3 flex items-center justify-center text-2xl" :class="member.bg">
                                <i :class="member.icon"></i>
                            </div>
                            <h3 class="font-bold text-slate-700">{{ member.name }}</h3>
                            <p class="text-xs text-slate-400 mt-1">{{ getMemberItemCount(member.name, 'shopping') }} é …å•†å“</p>
                            <div v-if="getMemberItemCount(member.name, 'shopping') > 0" class="absolute top-4 right-4 w-3 h-3 bg-red-400 rounded-full"></div>
                        </div>
                    </div>
                </div>

                <div v-else>
                    <div class="flex items-center mb-4">
                        <button @click="activeMember = null" class="mr-3 w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200"><i class="fa-solid fa-arrow-left"></i></button>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">{{ activeMember }}çš„é¡˜æœ›</h2>
                            <p class="text-xs text-slate-400">ç¸½é ç®—: Â¥{{ getMemberTotal(activeMember, 'shopping').toLocaleString() }}</p>
                        </div>
                    </div>

                    <div v-if="loading" class="flex justify-center py-10"><div class="loader"></div></div>
                    <div v-else-if="filteredShoppingList.length === 0" class="text-center py-10 text-slate-400"><i class="fa-solid fa-basket-shopping text-4xl mb-3 opacity-30"></i><p>é€™è£¡ç©ºç©ºçš„</p></div>

                    <div v-for="(item) in filteredShoppingList" :key="item.id" class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 mb-3 flex items-center relative group">
                        <button @click="deleteItem('shopping', item.id)" class="absolute top-2 right-2 text-slate-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                        <div class="w-12 h-12 bg-slate-100 rounded-lg mr-4 flex items-center justify-center text-slate-300"><i class="fa-solid fa-gift"></i></div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-700" :class="{'line-through text-slate-300': item.checked}">{{ item.name }}</h4>
                            <p class="text-xs text-slate-400">Â¥{{ item.price }} 
                                <span v-if="item.recipient" class="ml-2 bg-pink-100 text-pink-500 px-2 py-0.5 rounded-full text-[10px]"><i class="fa-solid fa-heart mr-1"></i>çµ¦: {{ item.recipient }}</span>
                            </p>
                        </div>
                        <input type="checkbox" :checked="item.checked" @change="toggleCheck(item.id, item.checked)" class="w-6 h-6 text-blue-500 rounded focus:ring-blue-500">
                    </div>
                    <button @click="showAddModal = 'shopping'" class="fixed bottom-6 right-6 w-14 h-14 bg-slate-800 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-50 hover:scale-110 transition"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>

            <div v-if="currentTab === 'expense'">
                <div v-if="!activeMember">
                    <div class="bg-slate-800 text-white rounded-2xl p-6 mb-6 shadow-lg text-center">
                        <p class="text-sm opacity-70 mb-1">å…¨å®¶ç¸½èŠ±è²» (TWD)</p>
                        <h3 class="text-4xl font-bold font-mono">{{ totalExpenseTWD.toLocaleString() }}</h3>
                    </div>

                    <h2 class="text-lg font-bold text-slate-800 mb-3">èª°ä»˜çš„éŒ¢ï¼Ÿ</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div v-for="member in familyMembers" :key="member.name" @click="activeMember = member.name" 
                             class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center cursor-pointer hover:shadow-md transition">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg mr-3" :class="member.bg"><i :class="member.icon"></i></div>
                            <div>
                                <h3 class="font-bold text-sm text-slate-700">{{ member.name }}</h3>
                                <p class="text-xs font-mono text-slate-400">Â¥{{ getMemberTotal(member.name, 'expense').toLocaleString() }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else>
                    <div class="flex items-center mb-4">
                        <button @click="activeMember = null" class="mr-3 w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200"><i class="fa-solid fa-arrow-left"></i></button>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">{{ activeMember }}ä»˜çš„éŒ¢</h2>
                            <p class="text-xs text-slate-400">å°è¨ˆ: Â¥{{ getMemberTotal(activeMember, 'expense').toLocaleString() }}</p>
                        </div>
                    </div>

                    <div v-if="loading" class="flex justify-center py-5"><div class="loader"></div></div>
                    <div v-else-if="filteredExpenseList.length === 0" class="text-center py-10 text-slate-400"><p>æ²’æœ‰ç´€éŒ„</p></div>

                    <div v-for="(exp) in filteredExpenseList" :key="exp.id" class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-50 relative mb-3">
                        <button @click="deleteItem('expense', exp.id)" class="absolute top-2 right-2 text-[10px] text-slate-200 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-yellow-50 text-yellow-500 flex items-center justify-center mr-3"><i class="fa-solid fa-yen-sign"></i></div>
                            <div>
                                <p class="font-bold text-sm">{{ exp.name }}</p>
                                <p class="text-xs text-slate-400">{{ exp.date }}</p>
                            </div>
                        </div>
                        <span class="font-mono font-bold text-slate-700">Â¥ {{ Number(exp.amount).toLocaleString() }}</span>
                    </div>
                    <button @click="showAddModal = 'expense'" class="fixed bottom-6 right-6 w-14 h-14 bg-slate-800 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-50 hover:scale-110 transition"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>

        </main>

        <div v-if="showAddModal" class="fixed inset-0 bg-black/50 z-[60] flex items-end sm:items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-bounce-in">
                <h3 class="text-lg font-bold mb-4">
                    {{ showAddModal === 'shopping' ? activeMember + 'æƒ³è²·ä»€éº¼?' : activeMember + 'ä»˜äº†ä»€éº¼éŒ¢?' }}
                </h3>
                <div class="space-y-3">
                    <div><label class="block text-xs text-slate-400 mb-1">åç¨±</label><input v-model="newItem.name" type="text" class="w-full bg-slate-100 rounded-lg p-3 outline-none"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">é‡‘é¡ (Â¥)</label><input v-model="newItem.amount" type="number" class="w-full bg-slate-100 rounded-lg p-3 outline-none"></div>
                    
                    <div v-if="showAddModal === 'shopping'">
                        <label class="block text-xs text-slate-400 mb-1">é€™è¦é€çµ¦èª°ï¼Ÿ(é¸å¡«)</label>
                        <input v-model="newItem.recipient" type="text" class="w-full bg-pink-50 rounded-lg p-3 outline-none text-pink-600" placeholder="ä¾‹å¦‚: åŒäº‹ã€é˜¿å§¨...">
                    </div>

                    <div v-if="showAddModal === 'expense'"><label class="block text-xs text-slate-400 mb-1">æ—¥æœŸ</label><input v-model="newItem.date" type="date" class="w-full bg-slate-100 rounded-lg p-3 outline-none"></div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button @click="closeModal" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold">å–æ¶ˆ</button>
                    <button @click="confirmAdd" class="flex-1 py-3 rounded-xl bg-blue-500 text-white font-bold">æ–°å¢</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // âœ… å·²å¡«å…¥æ‚¨çš„ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyC67N7fPsE8dHL3GMVfFpyfgrvDnE5AaVQ",
            authDomain: "hokkaido2026-b35fc.firebaseapp.com",
            databaseURL: "https://hokkaido2026-b35fc-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "hokkaido2026-b35fc",
            storageBucket: "hokkaido2026-b35fc.firebasestorage.app",
            messagingSenderId: "553111751124",
            appId: "1:553111751124:web:e15688b7b8966926882e41"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ğŸ“ è¡Œç¨‹è³‡æ–™ (å«ç²¾é¸åœ–ç‰‡)
        const scheduleData = [
            {
                date: "25", weekday: "Fri", location: "å‡½é¤¨", lat: 41.7687, lng: 140.7290,
                events: [
                    { time: "13:00", title: "æŠµé”æ–°åƒæ­²è½‰åœ‹å…§ç·š", category: "èˆªç­", transportType: "plane", travelTime: "1h", note: "è½‰æ©Ÿå¾€å‡½é¤¨", image: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=800&q=80" }, // é£›æ©Ÿ
                    { time: "16:30", title: "å‡½é¤¨ Check-in", category: "ä½å®¿", transportType: "taxi", travelTime: "20m", note: "å‡½é¤¨ç«™å‰é£¯åº—", image: "https://images.unsplash.com/photo-1566073771259-6a8506099945?w=800&q=80" }, // é£¯åº—ç¤ºæ„åœ–
                    { time: "17:30", title: "å‡½é¤¨æœå¸‚ / é‡‘æ£®å€‰åº«", category: "æ™¯é»", transportType: "walk", travelTime: "10m", note: "ç´…ç£šå€‰åº«æ•£æ­¥", image: "https://images.unsplash.com/photo-1542044801-30d3e45ae49a?w=800&q=80" }, // é‡‘æ£®å€‰åº«
                    { time: "19:00", title: "æ ¹å®¤èŠ±ä¸¸å£½å¸", category: "ç¾é£Ÿ", transportType: "walk", travelTime: "5m", note: "è¿´è½‰å£½å¸æ™šé¤", image: "https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=800&q=80" } // å£½å¸
                ]
            },
            {
                date: "26", weekday: "Sat", location: "å‡½é¤¨", lat: 41.7687, lng: 140.7290,
                events: [
                    { time: "09:00", title: "æ«»ä¸˜é€šè³æ«»", category: "æ™¯é»", transportType: "taxi", travelTime: "15m", note: "æ«»èŠ±éš§é“", image: "https://images.unsplash.com/photo-1522383225653-ed111181a951?w=800&q=80" }, // æ«»èŠ±
                    { time: "10:30", title: "äº”ç¨œéƒ­å…¬åœ’", category: "æ™¯é»", transportType: "walk", travelTime: "10m", note: "ç™»ä¸Šäº”ç¨œéƒ­å¡”", image: "https://images.unsplash.com/photo-1594970921430-47b19df49b82?w=800&q=80" }, // äº”ç¨œéƒ­å¡”
                    { time: "12:30", title: "å°ä¸‘æ¼¢å ¡", category: "ç¾é£Ÿ", transportType: "walk", travelTime: "5m", note: "å¿…åƒ! å¹¸é‹å°ä¸‘", image: "https://images.unsplash.com/photo-1551782450-a2132b4ba21d?w=800&q=80" }, // æ¼¢å ¡
                    { time: "15:30", title: "é‡‘æ£®å€‰åº«/æ˜Ÿå·´å…‹", category: "è³¼ç‰©", transportType: "bus", travelTime: "20m", note: "ä¼‘æ¯ã€å–å’–å•¡", image: "https://images.unsplash.com/photo-1509042239860-f550ce710b93?w=800&q=80" }, // å’–å•¡
                    { time: "17:30", title: "å‡½é¤¨å±±å¤œæ™¯", category: "æ™¯é»", transportType: "bus", travelTime: "20m", note: "ç™¾è¬å¤œæ™¯ Magic Hour", image: "https://images.unsplash.com/photo-1533050487297-09b450131914?w=800&q=80" } // å‡½é¤¨å¤œæ™¯
                ]
            },
            {
                date: "27", weekday: "Sun", location: "å‡½é¤¨", lat: 41.7687, lng: 140.7290,
                events: [
                    { time: "09:00", title: "å‡½é¤¨æœå¸‚", category: "ç¾é£Ÿ", transportType: "walk", travelTime: "10m", note: "æ—©é¤/é‡£çƒè³Š", image: "https://images.unsplash.com/photo-1534483509719-3feaee7c30da?w=800&q=80" }, // æµ·é®®å¸‚å ´
                    { time: "11:00", title: "å…ƒç”ºæ•™æœƒç¾¤", category: "æ™¯é»", transportType: "walk", travelTime: "15m", note: "ç•°åœ‹é¢¨æƒ…è¡—é“", image: "https://plus.unsplash.com/premium_photo-1661962495669-d72424626bd2?w=800&q=80" }, // æ•™å ‚/è¡—é“
                    { time: "15:00", title: "å‡½é¤¨å…¬åœ’", category: "æ™¯é»", transportType: "bus", travelTime: "20m", note: "è³æ«»èˆ‡è¿·ä½ éŠæ¨‚åœ’", image: "https://images.unsplash.com/photo-1572455044327-7348c1be7267?w=800&q=80" }, // å…¬åœ’
                    { time: "16:30", title: "é‡‘æ£®å€‰åº«æœ€å¾Œæ¡è²·", category: "è³¼ç‰©", transportType: "taxi", travelTime: "10m", note: "Snaffle's èµ·å¸è›‹ç³•", image: "https://images.unsplash.com/photo-1557925923-4706d5eb3d19?w=800&q=80" }, // ç”œé»
                    { time: "18:30", title: "é˜¿ä½åˆ©å£½å–œç‡’", category: "ç¾é£Ÿ", transportType: "walk", travelTime: "5m", note: "å’Œç‰›å£½å–œç‡’ (éœ€é ç´„)", image: "https://images.unsplash.com/photo-1588636402444-118e98b04618?w=800&q=80" } // å£½å–œç‡’
                ]
            },
            {
                date: "28", weekday: "Mon", location: "äºŒä¸–è°·", lat: 42.8048, lng: 140.6874,
                events: [
                    { time: "09:30", title: "å‡½é¤¨å–è»Š & å¯„è¡Œæ", category: "ç§Ÿè»Š", transportType: "walk", travelTime: "10m", note: "è‡ªé§•é–‹å§‹ï¼", image: "https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?w=800&q=80" }, // ç§Ÿè»Šè‡ªé§•
                    { time: "10:30", title: "å¤§æ²¼åœ‹å®šå…¬åœ’", category: "æ™¯é»", transportType: "car", travelTime: "40m", note: "é§’ä¹‹å²³çµ•æ™¯", image: "https://images.unsplash.com/photo-1624623253738-9e5c4908970d?w=800&q=80" }, // æ¹–æ™¯(ç¤ºæ„)
                    { time: "12:00", title: "æ£®ç”ºãƒ»é’è‘‰ä¸˜", category: "æ™¯é»", transportType: "car", travelTime: "20m", note: "è³æ«»ç§˜å¢ƒ", image: "https://images.unsplash.com/photo-1493589976221-c2157d91244d?w=800&q=80" }, // æ¨¹æ—æ«»èŠ±
                    { time: "14:30", title: "Silo å±•æœ›å°", category: "æ™¯é»", transportType: "car", travelTime: "90m", note: "çœºæœ›æ´çˆºæ¹–", image: "https://images.unsplash.com/photo-1517769971842-88f4b0051e23?w=800&q=80" }, // æ´çˆºæ¹–æ™¯
                    { time: "15:30", title: "Lake Hill Farm", category: "ç¾é£Ÿ", transportType: "car", travelTime: "10m", note: "ç‰§å ´å†°æ·‡æ·‹", image: "https://images.unsplash.com/photo-1563228965-03d3c4033288?w=800&q=80" }, // ç‰§å ´/å†°æ·‡æ·‹
                    { time: "18:00", title: "å…¥ä½äºŒä¸–è°·åˆ¥å¢…", category: "ä½å®¿", transportType: "car", travelTime: "40m", note: "æ™šé¤ï¼šæµ·é®®ç«é‹", image: "https://images.unsplash.com/photo-1566665797739-1674de7a421a?w=800&q=80" } // åˆ¥å¢…/æœ¨å±‹
                ]
            },
            {
                date: "29", weekday: "Tue", location: "æ´çˆºæ¹–", lat: 42.5646, lng: 140.8576,
                events: [
                    { time: "11:00", title: "å‡ºç™¼æ´çˆºæ¹–", category: "äº¤é€š", transportType: "car", travelTime: "0m", note: "ç¡åˆ°è‡ªç„¶é†’", image: "https://images.unsplash.com/photo-1558223694-8451b279d63f?w=800&q=80" }, // é–‹è»Šé¢¨æ™¯
                    { time: "12:30", title: "æœ‰ç å±±çºœè»Š", category: "æ™¯é»", transportType: "car", travelTime: "60m", note: "çœ‹ç«å±±åœ°å½¢", image: "https://images.unsplash.com/photo-1545653494-b772c672b152?w=800&q=80" }, // çºœè»Š
                    { time: "14:30", title: "æ´çˆºæ¹–éŠè¦½èˆ¹", category: "æ™¯é»", transportType: "car", travelTime: "20m", note: "ä¸­å³¶è³æ«»", image: "https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=800&q=80" }, // æ¹–èˆ‡èˆ¹
                    { time: "17:00", title: "è¶…å¸‚è£œè²¨", category: "è³¼ç‰©", transportType: "car", travelTime: "15m", note: "è²·æ™šé¤é£Ÿæ", image: "https://images.unsplash.com/photo-1578916171728-46686eac8d58?w=800&q=80" }, // è¶…å¸‚
                    { time: "19:00", title: "åˆ¥å¢…æ™šé¤", category: "ç¾é£Ÿ", transportType: "walk", travelTime: "0m", note: "è‡ªè£½æ¹¯å’–å“©", image: "https://images.unsplash.com/photo-1555126634-323283e090fa?w=800&q=80" } // å’–å“©
                ]
            },
            {
                date: "30", weekday: "Wed", location: "ç™»åˆ¥", lat: 42.4124, lng: 141.1065,
                events: [
                    { time: "10:00", title: "å‡ºç™¼ç™»åˆ¥", category: "äº¤é€š", transportType: "car", travelTime: "0m", note: "ç§»å‹•æ—¥", image: "https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=800&q=80" }, // å…¬è·¯æ—…è¡Œ
                    { time: "11:30", title: "ç™»åˆ¥æ«»èŠ±éš§é“", category: "æ™¯é»", transportType: "car", travelTime: "90m", note: "è³æ«»å‹åœ°", image: "https://images.unsplash.com/photo-1524231757912-21f4fe3a7200?w=800&q=80" }, // æ«»èŠ±è·¯
                    { time: "13:30", title: "ç™»åˆ¥åœ°ç„è°·", category: "æ™¯é»", transportType: "car", travelTime: "10m", note: "åœ°ç†±æ™¯è§€", image: "https://images.unsplash.com/photo-1600613277026-64539c279c09?w=800&q=80" }, // åœ°ç„è°·/ç¡«ç£º
                    { time: "16:00", title: "é«˜æ©‹ç‰§å ´", category: "ç¾é£Ÿ", transportType: "car", travelTime: "80m", note: "å¹´è¼ªè›‹ç³•/æ³¡èŠ™", image: "https://images.unsplash.com/photo-1529566118393-6cd79805d76d?w=800&q=80" }, // ç‰§å ´ç”œé»
                    { time: "17:00", title: "äº¬æ¥µåæ°´å…¬åœ’", category: "æ™¯é»", transportType: "car", travelTime: "20m", note: "è£åæ°´å›åˆ¥å¢…", image: "https://images.unsplash.com/photo-1433086966358-54859d0ed716?w=800&q=80" }, // ç€‘å¸ƒ/æ°´
                    { time: "19:00", title: "åˆ¥å¢…æ™šé¤", category: "ç¾é£Ÿ", transportType: "walk", travelTime: "0m", note: "å’Œç‰›ç‡’è‚‰è¶´", image: "https://images.unsplash.com/photo-1558030006-450675393462?w=800&q=80" } // ç‡’è‚‰
                ]
            },
            {
                date: "01", weekday: "Thu", location: "å°æ¨½", lat: 43.1907, lng: 140.9947,
                events: [
                    { time: "10:00", title: "äºŒä¸–è°·é‚„è»Š", category: "ç§Ÿè»Š", transportType: "car", travelTime: "0m", note: "æ› Alphard åŒ…è»Š", image: "https://images.unsplash.com/photo-1621905251189-08b45d6a269e?w=800&q=80" }, // åŒ…è»Š/è»Šå­
                    { time: "11:30", title: "ä½™å¸‚é…’å» +å ¤é˜²", category: "æ™¯é»", transportType: "car", travelTime: "60m", note: "å¨å£«å¿Œé…’å» ", image: "https://images.unsplash.com/photo-1596706912386-8a7c20c9f692?w=800&q=80" }, // é…’æ¡¶
                    { time: "13:00", title: "å°æ¨½é‹æ²³ & åˆé¤", category: "æ™¯é»", transportType: "car", travelTime: "30m", note: "è‹¥é›æ™‚ä»£/æ”¿å£½å¸", image: "https://images.unsplash.com/photo-1589453966567-27b4f5319803?w=800&q=80" }, // å°æ¨½é‹æ²³
                    { time: "15:00", title: "å ºç”ºé€š / æ‰‹å®®å…¬åœ’", category: "è³¼ç‰©", transportType: "walk", travelTime: "10m", note: "ç”œé»è¡—è³æ«»", image: "https://images.unsplash.com/photo-1527265103685-610190369888?w=800&q=80" }, // ç”œé»/è¡—é“
                    { time: "17:30", title: "æœ­å¹Œ Check-in", category: "ä½å®¿", transportType: "car", travelTime: "50m", note: "è¡Œæåˆé«”", image: "https://images.unsplash.com/photo-1620286866164-323620958d56?w=800&q=80" } // æœ­å¹Œ/é£¯åº—
                ]
            },
            {
                date: "02", weekday: "Fri", location: "æœ­å¹Œ", lat: 43.0618, lng: 141.3545,
                events: [
                    { time: "10:00", title: "åŒ—æµ·é“ç¥å®®", category: "æ™¯é»", transportType: "subway", travelTime: "20m", note: "åƒæ‹œ", image: "https://images.unsplash.com/photo-1590499690106-993d98fb870c?w=800&q=80" }, // ç¥ç¤¾
                    { time: "11:30", title: "åœ“å±±å…¬åœ’", category: "æ™¯é»", transportType: "walk", travelTime: "5m", note: "é‡é¤/è³æ«»", image: "https://images.unsplash.com/photo-1616556111075-8126b8061e88?w=800&q=80" }, // å…¬åœ’é‡é¤
                    { time: "12:30", title: "åœ“å±±å’–å•¡å»³", category: "ç¾é£Ÿ", transportType: "walk", travelTime: "10m", note: "æ–‡é’åˆé¤", image: "https://images.unsplash.com/photo-1554118811-1e0d58224f24?w=800&q=80" }, // å’–å•¡å»³
                    { time: "14:30", title: "åŒ—æµ·é“å¤§å­¸", category: "æ™¯é»", transportType: "subway", travelTime: "20m", note: "æ ¡åœ’æ•£æ­¥", image: "https://images.unsplash.com/photo-1634788102377-160171221430?w=800&q=80" }, // æ¨¹æ—æ ¡åœ’
                    { time: "16:30", title: "ç‹¸å°è·¯é€›è¡—", category: "è³¼ç‰©", transportType: "subway", travelTime: "15m", note: "è—¥å¦/ä¼´æ‰‹ç¦®", image: "https://images.unsplash.com/photo-1579758629938-03607ccdbaba?w=800&q=80" }, // å•†åº—è¡—
                    { time: "18:30", title: "æˆå‰æ€æ±—çƒ¤è‚‰", category: "ç¾é£Ÿ", transportType: "walk", travelTime: "10m", note: "å¤§å£åƒç¾Šè‚‰", image: "https://images.unsplash.com/photo-1594040226829-7f251ab46d80?w=800&q=80" } // çƒ¤è‚‰
                ]
            },
            {
                date: "03", weekday: "Sat", location: "åƒæ­²", lat: 42.7937, lng: 141.6795,
                events: [
                    { time: "10:30", title: "é£¯åº—æ¥é€", category: "äº¤é€š", transportType: "taxi", travelTime: "0m", note: "å°ˆè»Šç›´é”æ©Ÿå ´", image: "https://images.unsplash.com/photo-1632304918731-016335129995?w=800&q=80" }, // è¨ˆç¨‹è»Š
                    { time: "11:30", title: "æ–°åƒæ­²æ©Ÿå ´", category: "è³¼ç‰©", transportType: "car", travelTime: "50m", note: "æœ€å¾Œæ¡è²·", image: "https://images.unsplash.com/photo-1569154941061-e231b4725ef1?w=800&q=80" }, // æ©Ÿå ´/è³¼ç‰©
                    { time: "13:00", title: "æ­æ©Ÿè¿”å°", category: "èˆªç­", transportType: "plane", travelTime: "0m", note: "ç”œèœœçš„å®¶", image: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=800&q=80" } // é£›æ©Ÿ
                ]
            }
        ];

        createApp({
            data() {
                return {
                    isLocked: true, password: ['2','0','2','5'], inputPassword: [], 
                    headerImage: 'https://images.unsplash.com/photo-1548266652-99cf27701ced?q=80&w=1920&auto=format&fit=crop',
                    currentTab: 'schedule', scheduleData: scheduleData, selectedDayIndex: 0,
                    yenAmount: 1000, exchangeRate: 0.215,
                    shoppingList: [], expenseList: [], loading: true, dbConnected: false,
                    
                    // ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ äººç‰©è¨­å®š
                    familyMembers: [
                        { name: 'çˆ¸çˆ¸', icon: 'fa-solid fa-user-tie', bg: 'bg-blue-100 text-blue-500' },
                        { name: 'åª½åª½', icon: 'fa-solid fa-user-nurse', bg: 'bg-pink-100 text-pink-500' },
                        { name: 'å“¥å“¥', icon: 'fa-solid fa-user-graduate', bg: 'bg-green-100 text-green-500' },
                        { name: 'å¼Ÿå¼Ÿ', icon: 'fa-solid fa-child-reaching', bg: 'bg-yellow-100 text-yellow-500' }
                    ],
                    activeMember: null, // ç•¶å‰é¸ä¸­çš„äºº

                    showAddModal: null, newItem: { name: '', amount: '', date: '', recipient: '' },
                    infoCards: [ { title: 'èˆªç­', bgClass: 'bg-blue-50 text-blue-500', icon: 'fa-solid fa-plane' }, { title: 'ä½å®¿', bgClass: 'bg-orange-50 text-orange-500', icon: 'fa-solid fa-hotel' }, { title: 'ç§Ÿè»Š', bgClass: 'bg-green-50 text-green-500', icon: 'fa-solid fa-car' }, { title: 'é†«ç™‚', bgClass: 'bg-red-50 text-red-500', icon: 'fa-solid fa-suitcase-medical' } ],
                    weatherLoading: false, currentWeather: { temp: '--', desc: 'è¼‰å…¥ä¸­', icon: 'fa-solid fa-cloud' }
                }
            },
            mounted() {
                onValue(ref(db, 'shopping'), (s) => { const d=s.val(); this.shoppingList=d?Object.keys(d).map(k=>({id:k,...d[k]})):[]; this.loading=false; this.dbConnected=true; });
                onValue(ref(db, 'expenses'), (s) => { const d=s.val(); this.expenseList=d?Object.keys(d).map(k=>({id:k,...d[k]})):[]; });
                this.newItem.date = new Date().toISOString().split('T')[0];
                this.fetchWeather();
            },
            watch: { selectedDayIndex() { this.fetchWeather(); } },
            computed: {
                currentSchedule() { return this.scheduleData[this.selectedDayIndex] || { events: [] }; },
                calculatedTwd() { return Math.round(this.yenAmount * this.exchangeRate).toLocaleString(); },
                totalExpenseTWD() { return Math.round(this.expenseList.reduce((sum, item) => sum + Number(item.amount), 0) * this.exchangeRate); },
                // ğŸ” éæ¿¾é‚è¼¯
                filteredShoppingList() { return this.shoppingList.filter(item => item.creator === this.activeMember); },
                filteredExpenseList() { return this.expenseList.filter(item => item.creator === this.activeMember); }
            },
            methods: {
                // ğŸ“Š çµ±è¨ˆæ–¹æ³•
                getMemberItemCount(name, type) { 
                    const list = type === 'shopping' ? this.shoppingList : this.expenseList;
                    return list.filter(i => i.creator === name).length;
                },
                getMemberTotal(name, type) {
                    const list = type === 'shopping' ? this.shoppingList : this.expenseList;
                    return list.filter(i => i.creator === name).reduce((sum, i) => sum + Number(type==='shopping' ? i.price : i.amount), 0);
                },
                switchTab(tab) { this.currentTab = tab; this.activeMember = null; }, // åˆ‡æ›åˆ†é æ™‚é‡ç½®é¸äºº

                async fetchWeather() {
                    this.weatherLoading = true; const day = this.currentSchedule; if (!day.lat) return;
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${day.lat}&longitude=${day.lng}&current_weather=true`);
                        const data = await res.json();
                        const w = data.current_weather;
                        let icon='fa-solid fa-cloud', desc='å¤šé›²';
                        if(w.weathercode===0){icon='fa-solid fa-sun text-yellow-400';desc='æ™´';}
                        else if(w.weathercode<=67){icon='fa-solid fa-cloud-rain text-blue-300';desc='é›¨';}
                        else if(w.weathercode<=77){icon='fa-solid fa-snowflake text-white';desc='é›ª';}
                        this.currentWeather = { temp: w.temperature, desc: desc, icon: icon };
                    } catch(e){} finally{this.weatherLoading=false;}
                },
                enterDigit(n) { if(this.inputPassword.length<4) { this.inputPassword.push(String(n)); if(this.inputPassword.length===4) this.checkPassword(); } },
                backspace() { this.inputPassword.pop(); },
                checkPassword() { if(JSON.stringify(this.inputPassword) === JSON.stringify(this.password)) setTimeout(() => this.isLocked = false, 300); },
                tabClass(tab) { return this.currentTab === tab ? 'bg-blue-500 text-white scale-110' : 'bg-white text-slate-400 hover:bg-blue-50'; },
                getTabIcon(t) { return {'schedule':'fa-solid fa-map-location-dot','info':'fa-solid fa-circle-info','shopping':'fa-solid fa-basket-shopping','expense':'fa-solid fa-yen-sign'}[t]; },
                getCategoryColor(c) { return {'æ™¯é»':'bg-pink-400','ç¾é£Ÿ':'bg-orange-400','ä½å®¿':'bg-indigo-400','è³¼ç‰©':'bg-yellow-400','èˆªç­':'bg-blue-400','ç§Ÿè»Š':'bg-green-500','äº¤é€š':'bg-slate-400'}[c] || 'bg-gray-400'; },
                getCategoryIcon(c) { return {'æ™¯é»':'fa-solid fa-camera','ç¾é£Ÿ':'fa-solid fa-utensils','ä½å®¿':'fa-solid fa-bed','è³¼ç‰©':'fa-solid fa-bag-shopping','èˆªç­':'fa-solid fa-plane','ç§Ÿè»Š':'fa-solid fa-car','äº¤é€š':'fa-solid fa-train-subway'}[c] || 'fa-solid fa-circle'; },
                getTransportIcon(t) { return {'walk':'fa-solid fa-person-walking','car':'fa-solid fa-car-side','bus':'fa-solid fa-bus','subway':'fa-solid fa-train-subway','taxi':'fa-solid fa-taxi','plane':'fa-solid fa-plane-up'}[t] || 'fa-solid fa-arrow-right'; },
                
                closeModal() { this.showAddModal = null; this.newItem = { name:'', amount:'', date: new Date().toISOString().split('T')[0], recipient: '' }; },
                confirmAdd() {
                    if (!this.newItem.name) return;
                    // ğŸ”¥ è‡ªå‹•å¸¶å…¥ç•¶å‰ activeMember
                    if (this.showAddModal === 'shopping') {
                        push(ref(db, 'shopping'), { name: this.newItem.name, price: this.newItem.amount || 0, creator: this.activeMember, recipient: this.newItem.recipient, checked: false });
                    } else {
                        push(ref(db, 'expenses'), { name: this.newItem.name, amount: this.newItem.amount || 0, date: this.newItem.date, creator: this.activeMember });
                    }
                    this.closeModal();
                },
                deleteItem(type, id) { if(confirm('ç¢ºå®šåˆªé™¤?')) remove(ref(db, (type==='shopping'?'shopping/':'expenses/')+id)); },
                toggleCheck(id, s) { update(ref(db, `shopping/${id}`), { checked: !s }); }
            }
        }).mount('#app');
    </script>
</body>
</html>
